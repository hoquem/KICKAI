# KICKAI Changelog

## [2025-08-23] - CrewAI Version Update

### Updated
- **CrewAI**: Updated to latest version 0.165.1 from 0.159.0 (production) and 0.157.0 (development)
  - Updated both `requirements.txt` and `requirements-local.txt`
  - Updated local virtual environment to use latest version
  - Verified compatibility with existing codebase
  - Benefits: Latest bug fixes, improved memory system, enhanced tracing capabilities

### Technical Details
- **Production**: Updated from 0.159.0 to 0.165.1
- **Development**: Updated from 0.157.0 to 0.165.1
- **Key Improvements**: Enhanced memory system, improved tracing, bug fixes
- **Compatibility**: ✅ All existing functionality verified working
- **Risk Level**: Low - mostly bug fixes and improvements

## [2025-08-23] - String Formatting Fix

### Fixed
- **CRITICAL**: Fixed string formatting error in routing_recommendation_tool
  - Escaped curly braces in JSON template within f-string
  - Resolved "Invalid format specifier" error in NLP processor
  - Fixed JSON template formatting in routing prompt generation
  - Ensured proper f-string syntax for JSON response format

### Technical Details
- **File**: `kickai/agents/nlp_processor.py`
- **Issue**: JSON template curly braces `{}` interpreted as format specifiers
- **Solution**: Escaped curly braces by doubling them `{{}}`
- **Impact**: Resolves routing recommendation tool errors

## [2025-08-23] - NLP Processor Async Conversion

### Fixed
- **CRITICAL**: Converted all NLP processor tools to async functions
  - Converted 6 sync domain functions to async: `advanced_intent_recognition_domain`, `entity_extraction_domain`, `conversation_context_domain`, `semantic_similarity_domain`, `analyze_update_context_domain`, `validate_routing_permissions_domain`
  - Resolved "ARCHITECTURE VIOLATION" errors in async tool registry
  - Ensured 100% async architecture compliance for 2025 standards
  - All tools now properly register with AsyncToolRegistry

### Technical Details
- **File**: `kickai/agents/nlp_processor.py`
- **Issue**: Sync tools violating 2025 async-only architecture
- **Solution**: Added `async` keyword to all domain function definitions
- **Impact**: All NLP tools now properly async and registry-compliant

## [2025-08-23] - JSON Parsing Fix

### Fixed
- **CRITICAL**: Fixed JSON parsing error in NLP routing recommendation method
  - Added proper input validation for empty or invalid JSON responses
  - Implemented graceful handling of "Expecting value: line 1 column 1 (char 0)" error
  - Enhanced error logging with response content for debugging
  - Improved fallback parsing for backwards compatibility
  - Resolved CrewAI agent crashes due to invalid JSON parsing

### Technical Details
- **File**: `kickai/agents/crew_agents.py`
- **Issue**: `json.loads("")` throwing "Expecting value: line 1 column 1 (char 0)" error
- **Solution**: Added input validation and proper error handling
- **Impact**: CrewAI agents now handle empty/invalid responses gracefully

## [2025-08-23] - CrewAI Parameter Passing Fix

### Fixed
- **CRITICAL**: Fixed CrewAI parameter passing in update_player_field tool
  - Implemented proper handling of CrewAI's dictionary parameter passing
  - Added parameter extraction logic for CrewAI's standard parameter format
  - Enhanced tool to handle CrewAI's normal parameter passing behavior
  - Resolved "Arguments validation failed" errors in CrewAI tool calls
  - Added comprehensive parameter validation and type conversion

### Technical Details
- **File**: `kickai/features/player_registration/application/tools/player_update_tools.py`
- **Issue**: CrewAI passes parameters as dictionary (normal behavior) but tool expected individual arguments
  - Error: "Arguments validation failed: 6 validation errors for Update_Player_Field"
  - Tool name conversion: `update_player_field` → `Update_Player_Field`
- **Solution**: Added dictionary parameter extraction (normal CrewAI behavior)
- **Impact**: `/update` commands now work correctly with CrewAI agents
