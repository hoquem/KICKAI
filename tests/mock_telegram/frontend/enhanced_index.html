<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Mock Telegram Tester</title>
    <style>
        :root {
            /* Primary Colors */
            --primary-blue: #1a73e8;
            --primary-green: #34a853;
            --primary-red: #ea4335;
            --primary-yellow: #fbbc04;
            
            /* Status Colors */
            --status-online: #34a853;
            --status-offline: #ea4335;
            --status-warning: #fbbc04;
            
            /* User Role Colors */
            --role-player: #4285f4;
            --role-admin: #ea4335;
            --role-leadership: #fbbc04;
            --role-member: #34a853;
            
            /* Neutral Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e8eaed;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .header h1 {
            color: var(--primary-blue);
            margin-bottom: 8px;
            font-size: 28px;
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
        }
        
        .sidebar {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .chat-area {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 700px;
        }
        
        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 12px 12px 0 0;
        }
        
        .chat-messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-secondary);
        }
        
        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .message.user {
            background: var(--primary-blue);
            color: white;
            margin-left: auto;
        }
        
        .message.bot {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary-blue);
            margin-left: 20px;
        }
        
        .message-content {
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .message-content code {
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .message-content strong {
            font-weight: 600;
        }
        
        .message-content br {
            margin-bottom: 4px;
        }
        
        .message-info {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .chat-input {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 0 0 12px 12px;
        }
        
        .input-group {
            display: flex;
            gap: 12px;
        }
        
        .input-group input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        .input-group button {
            padding: 14px 24px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .input-group button:hover {
            background: #1557b0;
        }
        
        .input-group button:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        /* System Status */
        .system-status {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .status-value {
            font-weight: 500;
        }
        
        .status-value.online {
            color: var(--status-online);
        }
        
        .status-value.offline {
            color: var(--status-offline);
        }
        
        /* User Selection */
        .user-selection {
            margin-bottom: 24px;
        }
        
        .user-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .category-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .category-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        
        .user-search {
            margin-bottom: 16px;
        }
        
        .user-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .user-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .user-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-item:hover {
            background: var(--bg-secondary);
        }
        
        .user-item.active {
            background: #e3f2fd;
            border-left: 4px solid var(--primary-blue);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 16px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .user-role {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .user-phone {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .user-permissions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .permission-badge {
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        .permission-badge.main-chat {
            background: #e8f5e8;
            color: var(--primary-green);
        }
        
        .permission-badge.leadership-chat {
            background: #fff3e0;
            color: var(--primary-yellow);
        }
        
        /* Chat Selection */
        .chat-selection {
            margin-bottom: 24px;
        }
        
        .chat-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .chat-tab {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .chat-tab.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        
        .chat-context {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Test Templates */
        .test-templates {
            margin-bottom: 24px;
        }
        
        .test-templates h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .template-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .template-btn {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            transition: all 0.2s;
        }
        
        .template-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-blue);
        }
        
        /* Message Controls */
        .message-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        
        .message-search {
            flex: 1;
            display: flex;
            gap: 8px;
        }
        
        .message-search input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .search-btn {
            padding: 8px 12px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .message-filters select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .message-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .action-btn:hover {
            background: var(--bg-secondary);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
                margin-top: 20px;
            }
            
            .chat-area {
                order: 1;
            }
            
            .system-status {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .template-buttons {
                grid-template-columns: 1fr;
            }
            
            .message-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Enhanced Mock Telegram Tester</h1>
            <p>Test your KICKAI bot system with real Firebase user data</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <!-- System Status -->
                <div class="system-status">
                    <div class="status-item">
                        <span class="status-icon">ü§ñ</span>
                        <span class="status-label">Bot</span>
                        <span class="status-value" id="botStatus">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">üî•</span>
                        <span class="status-label">Firebase</span>
                        <span class="status-value" id="firebaseStatus">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">üß†</span>
                        <span class="status-label">AI Provider</span>
                        <span class="status-value" id="aiProvider">Hugging Face</span>
                    </div>
                </div>
                
                <!-- User Selection -->
                <div class="user-selection">
                    <h3>üë• Firebase Users</h3>
                    <div class="user-categories">
                        <button class="category-btn active" data-category="all">All</button>
                        <button class="category-btn" data-category="players">Players</button>
                        <button class="category-btn" data-category="team-members">Team Members</button>
                        <button class="category-btn" data-category="admins">Admins</button>
                    </div>
                    
                    <div class="user-search">
                        <input type="text" placeholder="Search users..." id="userSearch">
                    </div>
                    
                    <div class="user-list" id="userList">
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                            Loading Firebase users...
                        </div>
                    </div>
                </div>
                
                <!-- Chat Selection -->
                <div class="chat-selection">
                    <h3>üí¨ Select Chat</h3>
                    <div class="chat-tabs">
                        <button class="chat-tab active" data-chat="main">
                            üè† Main Chat
                        </button>
                        <button class="chat-tab" data-chat="leadership">
                            üëë Leadership
                        </button>
                        <button class="chat-tab" data-chat="private">
                            üí¨ Private
                        </button>
                    </div>
                    
                    <div class="chat-context">
                        <p class="chat-description">Main team chat for all players</p>
                        <p class="chat-permissions">All users can send messages</p>
                    </div>
                </div>
                
                <!-- Test Templates -->
                <div class="test-templates">
                    <h4>üöÄ Quick Test Scenarios</h4>
                    <div class="template-buttons">
                        <button class="template-btn" data-scenario="player-registration">
                            üèÉ Player Registration
                        </button>
                        <button class="template-btn" data-scenario="match-creation">
                            ‚öΩ Match Creation
                        </button>
                        <button class="template-btn" data-scenario="attendance-marking">
                            ‚úÖ Attendance Marking
                        </button>
                        <button class="template-btn" data-scenario="payment-processing">
                            üí∞ Payment Processing
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-header">
                    <h3 id="chatTitle">Select a user to start chatting</h3>
                </div>
                
                <!-- Message Controls -->
                <div class="message-controls">
                    <div class="message-search">
                        <input type="text" placeholder="Search messages..." id="messageSearch">
                        <button class="search-btn">üîç</button>
                    </div>
                    
                    <div class="message-filters">
                        <select id="messageTypeFilter">
                            <option value="all">All Messages</option>
                            <option value="commands">Commands Only</option>
                            <option value="bot-responses">Bot Responses</option>
                            <option value="user-messages">User Messages</option>
                        </select>
                    </div>
                    
                    <div class="message-actions">
                        <button class="action-btn" id="exportBtn">üì§ Export</button>
                        <button class="action-btn" id="clearBtn">üóëÔ∏è Clear</button>
                    </div>
                </div>
                
                <div id="chatMessages" class="chat-messages">
                    <div class="message bot">
                        <div class="message-info">ü§ñ KickAI Bot</div>
                        Welcome to the Enhanced Mock Telegram Tester! Select a Firebase user from the sidebar to start testing with real data.
                    </div>
                </div>
                
                <div class="chat-input">
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Select a user first..."
                            disabled
                        >
                        <button disabled id="sendButton">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentChat = null;
        let firebaseUsers = [];
        let mockUsers = [];
        let chats = [];
        let ws = null;
        let currentCategory = 'all';
        
        // API base URL - Single source of truth
        const API_BASE = 'http://localhost:8001/api';
        
        // Initialize the application
        async function init() {
            await checkSystemStatus();
            await loadFirebaseUsers();
            await loadMockUsers();
            await loadChats();
            connectWebSocket();
            setupEventListeners();
        }
        
        // Check system status
        async function checkSystemStatus() {
            try {
                // Check bot status using stats endpoint instead of health
                const botResponse = await fetch(`${API_BASE}/stats`);
                if (botResponse.ok) {
                    const stats = await botResponse.json();
                    if (stats.bot_integration_available) {
                        document.getElementById('botStatus').textContent = 'Online';
                        document.getElementById('botStatus').className = 'status-value online';
                    } else {
                        document.getElementById('botStatus').textContent = 'Offline';
                        document.getElementById('botStatus').className = 'status-value offline';
                    }
                } else {
                    document.getElementById('botStatus').textContent = 'Offline';
                    document.getElementById('botStatus').className = 'status-value offline';
                }
                
                // Check Firebase status
                const firebaseResponse = await fetch(`${API_BASE}/firebase/users`);
                if (firebaseResponse.ok) {
                    document.getElementById('firebaseStatus').textContent = 'Connected';
                    document.getElementById('firebaseStatus').className = 'status-value online';
                } else {
                    document.getElementById('firebaseStatus').textContent = 'Disconnected';
                    document.getElementById('firebaseStatus').className = 'status-value offline';
                }
            } catch (error) {
                console.error('Error checking system status:', error);
                document.getElementById('botStatus').textContent = 'Error';
                document.getElementById('botStatus').className = 'status-value offline';
                document.getElementById('firebaseStatus').textContent = 'Error';
                document.getElementById('firebaseStatus').className = 'status-value offline';
            }
        }
        
        // Load Firebase users
        async function loadFirebaseUsers() {
            try {
                const response = await fetch(`${API_BASE}/firebase/users`);
                if (response.ok) {
                    const data = await response.json();
                    firebaseUsers = data.users || []; // Extract the users array from the response
                    renderUsers();
                } else {
                    console.error('Failed to load Firebase users');
                    firebaseUsers = [];
                    renderUsers(); // Render empty state
                }
            } catch (error) {
                console.error('Error loading Firebase users:', error);
                firebaseUsers = [];
                renderUsers(); // Render empty state
            }
        }
        
        // Load mock users
        async function loadMockUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                if (response.ok) {
                    const data = await response.json();
                    mockUsers = data.users || []; // Extract the users array from the response
                } else {
                    mockUsers = [];
                }
            } catch (error) {
                console.error('Error loading mock users:', error);
                mockUsers = [];
            }
        }
        
        // Load chats
        async function loadChats() {
            try {
                const response = await fetch(`${API_BASE}/chats`);
                if (response.ok) {
                    const data = await response.json();
                    chats = data.chats || data || []; // Handle both nested and direct array responses
                } else {
                    chats = [];
                }
            } catch (error) {
                console.error('Error loading chats:', error);
                chats = [];
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Category buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    renderUsers();
                });
            });
            
            // Chat tabs
            document.querySelectorAll('.chat-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    selectChat(tab.dataset.chat);
                });
            });
            
            // Template buttons
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    runTestScenario(btn.dataset.scenario);
                });
            });
            
            // User search
            document.getElementById('userSearch').addEventListener('input', (e) => {
                filterUsers(e.target.value);
            });
            
            // User selection using event delegation (best practice)
            document.getElementById('userList').addEventListener('click', (e) => {
                const userItem = e.target.closest('.user-item');
                if (userItem) {
                    const telegramId = userItem.dataset.telegramId;
                    
                    // Find the user data from firebaseUsers
                    const user = firebaseUsers.find(u => u.id === telegramId);
                    if (user) {
                        selectUser(user);
                    }
                }
            });
            
            // Send button
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            
            // Enter key in message input
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Export and clear buttons
            document.getElementById('exportBtn').addEventListener('click', exportChat);
            document.getElementById('clearBtn').addEventListener('click', clearChat);
        }
        
        // Render users based on category and search
        function renderUsers() {
            const userList = document.getElementById('userList');
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            
            // Filter users by category and search
            let filteredUsers = firebaseUsers.filter(user => {
                const matchesCategory = currentCategory === 'all' || 
                    (currentCategory === 'players' && user.role === 'player') ||
                    (currentCategory === 'team-members' && user.role === 'team_member') ||
                    (currentCategory === 'admins' && (user.role === 'admin' || user.role === 'leadership'));
                
                const fullName = `${user.first_name} ${user.last_name || ''}`.trim();
                const matchesSearch = fullName.toLowerCase().includes(searchTerm) ||
                    user.username?.toLowerCase().includes(searchTerm) ||
                    user.role?.toLowerCase().includes(searchTerm);
                
                return matchesCategory && matchesSearch;
            });
            
            userList.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                userList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        No users found
                    </div>
                `;
                return;
            }
            
            filteredUsers.forEach(user => {
                const userElement = createUserElement(user);
                userList.appendChild(userElement);
            });
        }
        
        // Create user element
        function createUserElement(user) {
            const li = document.createElement('li');
            li.className = 'user-item';
            li.dataset.telegramId = user.id; // Use user.id as telegram_id
            li.dataset.userId = user.id; // Use user.id as user_id
            
            const fullName = `${user.first_name} ${user.last_name || ''}`.trim();
            const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase() || 'U';
            const roleColor = user.role === 'player' ? 'var(--role-player)' : 
                            user.role === 'admin' || user.role === 'leadership' ? 'var(--role-admin)' : 
                            'var(--role-member)';
            
            li.innerHTML = `
                <div class="user-avatar" style="background: ${roleColor}">
                    ${initials}
                </div>
                <div class="user-info">
                    <div class="user-name">${fullName}</div>
                    <div class="user-role">
                        <span>@${user.username}</span>
                        <span>‚Ä¢</span>
                        <span>${user.role}</span>
                    </div>
                    <div class="user-phone">${user.phone_number || 'No phone'}</div>
                </div>
                <div class="user-permissions">
                    <span class="permission-badge main-chat">Main Chat</span>
                    ${user.role === 'admin' || user.role === 'leadership' ? 
                        '<span class="permission-badge leadership-chat">Leadership</span>' : ''}
                </div>
            `;
            
            return li;
        }
        
        // Filter users
        function filterUsers(searchTerm) {
            renderUsers();
        }
        
        // Select a user
        function selectUser(user) {
            currentUser = user;
            
            // Update UI - remove active class from all users
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to the clicked user
            const userElement = document.querySelector(`[data-telegram-id="${user.id}"]`);
            if (userElement) {
                userElement.classList.add('active');
            }
            
            // Enable message input
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = false;
            sendButton.disabled = false;
            const fullName = `${user.first_name} ${user.last_name || ''}`.trim();
            messageInput.placeholder = `Send message as ${fullName}...`;
            
            // Update chat title to show selected user
            updateChatTitle();
            
            // If no chat is selected, select main chat
            if (!currentChat) {
                selectChat('main');
            }
        }
        
        // Update chat title based on current selection
        function updateChatTitle() {
            const chatTitle = document.getElementById('chatTitle');
            if (currentUser && currentChat) {
                let chatType = '';
                if (currentChat.is_main_chat) {
                    chatType = 'Main Chat';
                } else if (currentChat.is_leadership_chat) {
                    chatType = 'Leadership';
                } else {
                    chatType = 'Private';
                }
                const fullName = `${currentUser.first_name} ${currentUser.last_name || ''}`.trim();
                chatTitle.textContent = `Chat with ${fullName} (${chatType})`;
            } else if (currentUser) {
                const fullName = `${currentUser.first_name} ${currentUser.last_name || ''}`.trim();
                chatTitle.textContent = `Select a chat for ${fullName}`;
            } else {
                chatTitle.textContent = 'Select a user to start chatting';
            }
        }
        
        // Select a chat
        function selectChat(chatType) {
            const chat = chats.find(c => {
                if (chatType === 'main') return c.is_main_chat;
                if (chatType === 'leadership') return c.is_leadership_chat;
                return false;
            });
            
            if (!chat) {
                console.warn('No chat found for type:', chatType);
                return;
            }
            
            currentChat = chat;
            
            // Update chat title
            updateChatTitle();
            
            // Update chat description
            let chatDescription = '';
            let chatPermissions = '';
            
            if (chat.is_main_chat) {
                chatDescription = 'Main team chat for all players';
                chatPermissions = 'All users can send messages';
            } else if (chat.is_leadership_chat) {
                chatDescription = 'Leadership chat for admins and managers';
                chatPermissions = 'Admin users only';
            }
            
            const descriptionElement = document.querySelector('.chat-description');
            const permissionsElement = document.querySelector('.chat-permissions');
            
            if (descriptionElement) descriptionElement.textContent = chatDescription;
            if (permissionsElement) permissionsElement.textContent = chatPermissions;
            
            // Load chat history
            loadChatHistory(chat.id);
        }
        
        // Load chat history
        async function loadChatHistory(chatId) {
            try {
                const response = await fetch(`${API_BASE}/chats/${chatId}/messages`);
                if (response.ok) {
                    const messages = await response.json();
                    
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    messages.forEach(message => {
                        addMessageToChat(message);
                    });
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }
        
        // Send a message
        async function sendMessage() {
            if (!currentUser || !currentChat) {
                alert('Please select a user and chat first');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const messageData = {
                user_id: parseInt(currentUser.id),
                chat_id: currentChat.id,
                text: text
            };
            
            try {
                const response = await fetch(`${API_BASE}/send_message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(messageData)
                });
                
                if (response.ok) {
                    input.value = '';
                } else {
                    const errorData = await response.json();
                    console.error('Error sending message:', errorData);
                    alert(`Error: ${errorData.detail || 'Failed to send message'}`);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }
        

        
        // Run test scenario
        function runTestScenario(scenario) {
            if (!currentUser) {
                alert('Please select a user first');
                return;
            }
            
            const scenarios = {
                'player-registration': '/addplayer Test Player +1234567890 Forward',
                'match-creation': '/creatematch Test Match 2024-01-15 14:00 Home',
                'attendance-marking': '/markattendance MATCH001 present',
                'payment-processing': '/createpayment Test Payment 50.00 match_fee'
            };
            
            const messageInput = document.getElementById('messageInput');
            messageInput.value = scenarios[scenario] || '';
            sendMessage();
        }
        
        // Export chat
        function exportChat() {
            const chatMessages = document.getElementById('chatMessages');
            const messages = Array.from(chatMessages.children).map(msg => {
                const info = msg.querySelector('.message-info').textContent;
                const text = msg.textContent.replace(info, '').trim();
                return `${info}: ${text}`;
            });
            
            const blob = new Blob([messages.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-export-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Clear chat
        function clearChat() {
            if (confirm('Are you sure you want to clear the chat?')) {
                document.getElementById('chatMessages').innerHTML = '';
            }
        }
        
        // Connect to WebSocket
        function connectWebSocket() {
            ws = new WebSocket(`ws://localhost:8001/ws`);
            
            ws.onopen = function() {
                // WebSocket connected
            };
            
            ws.onclose = function() {
                // WebSocket disconnected, attempt reconnection
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }
        
        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            try {
                if (data.type === 'new_message') {
                    addMessageToChat(data.message);
                } else if (data.type === 'bot_response') {
                    addBotMessageToChat(data.message);
                }
            } catch (error) {
                console.error('Error handling WebSocket message:', error);
            }
        }
        
        // Add a user message to the chat
        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            const time = new Date(message.date * 1000).toLocaleTimeString();
            messageDiv.innerHTML = `
                <div class="message-info">${message.from.first_name} ‚Ä¢ ${time}</div>
                ${message.text}
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Add a bot message to the chat
        function addBotMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            let time = 'Now';
            if (message.date) {
                try {
                    const date = new Date(message.date * 1000);
                    if (!isNaN(date.getTime())) {
                        time = date.toLocaleTimeString();
                    }
                } catch (error) {
                    console.warn('Error formatting bot message date:', error);
                }
            }
            
            // Handle different message formats
            let messageText = '';
            if (typeof message === 'string') {
                messageText = message;
            } else if (message && typeof message === 'object') {
                // Handle AgentResponse objects
                if (message.message && message.success !== undefined) {
                    messageText = message.message;
                } else if (message.text) {
                    messageText = message.text;
                } else {
                    messageText = JSON.stringify(message);
                }
            } else {
                messageText = 'No response text';
            }
            
            // Format the message text for better display
            messageText = formatMessageText(messageText);
            
            messageDiv.innerHTML = `
                <div class="message-info">ü§ñ KickAI Bot ‚Ä¢ ${time}</div>
                <div class="message-content">${messageText}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Format message text for better display
        function formatMessageText(text) {
            if (!text) return '';
            
            // Convert line breaks to HTML
            text = text.replace(/\n/g, '<br>');
            
            // Highlight emojis and make them larger (simplified regex to avoid issues)
            text = text.replace(/([üë§üë•üìãüîëüé≠üè¢üì±üìßüìÖüîÑ‚úÖ‚è≥üî¥‚ùå‚ùìüí°üìûü§ñ‚öΩüè∑Ô∏è])/g, 
                '<span style="font-size: 1.2em; margin: 0 2px;">$1</span>');
            
            // Highlight command-like text
            text = text.replace(/(\/[a-zA-Z]+)/g, '<code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
            
            // Highlight important sections
            text = text.replace(/(‚ùì.*?)(?=<br>|$)/g, '<strong style="color: #1a73e8;">$1</strong>');
            text = text.replace(/(üí°.*?)(?=<br>|$)/g, '<strong style="color: #34a853;">$1</strong>');
            text = text.replace(/(üìû.*?)(?=<br>|$)/g, '<strong style="color: #ea4335;">$1</strong>');
            
            return text;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 